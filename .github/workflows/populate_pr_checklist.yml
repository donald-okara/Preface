name: PR Template and Deliverables

on:
  pull_request:
    types: [opened, edited]

jobs:
  update-pr-body:
    runs-on: ubuntu-latest
    steps:
      - name: Update PR Body
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Define the template for a blank PR body
            const template = `## âœ¨ Description

            <!-- Clearly describe what this PR does. What feature, fix, or update are you introducing? -->

            ---

            ## ğŸ› Related Issue

            Closes #

            ---

            ## ğŸš§ Deliverables from Issue

            <!-- These will be auto-filled from the related issue if matched. -->

            ---

            ## âœ… Checklist

            - âŒ ğŸ’» Code compiles and builds successfully without errors
            - âŒ ğŸ§ª Relevant tests (unit/integration) are added or updated
            - âŒ ğŸ† All tests pass locally and on CI
            - âŒ ğŸ“š Documentation has been updated (if applicable)
            - âŒ ğŸ‘€ Reviewer(s) have been assigned

            ---

            ## ğŸ’¬ Additional Notes

            <!-- Optional: Any extra context, decisions made, or things to look out for -->`;

            // If PR body is blank, insert the template
            if (!prBody.trim()) {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                body: template
              });
            } else {
              // Extract issue number from "Related Issue" section or PR title
              let issueNumber = null;
              const relatedIssueSection = prBody.match(/## ğŸ› Related Issue\n([\s\S]*?)(?=\n## |$)/);
              if (relatedIssueSection) {
                const closesMatch = relatedIssueSection[1].match(/closes\s+#(\d+)/i);
                if (closesMatch) issueNumber = closesMatch[1];
              }
              if (!issueNumber) {
                const titleMatch = prTitle.match(/\b(fix|fixes|fixed|close|closes|closed|resolve|resolves|resolved)\s+#(\d+)/i);
                if (titleMatch) issueNumber = titleMatch[2];
              }

              // If an issue number is found, update deliverables
              if (issueNumber) {
                // Fetch the issue body
                const issue = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber
                });
                const issueBody = issue.data.body || '';

                // Extract deliverables from the issue
                const deliverablesSection = issueBody.match(/## Deliverables\n([\s\S]*?)(?=\n## |$)/);
                let issueDeliverables = [];
                if (deliverablesSection) {
                  const listItems = deliverablesSection[1].match(/- .+/g);
                  if (listItems) {
                    issueDeliverables = listItems.map(item => item.replace(/^- /, '').trim());
                  }
                }

                // Parse current PR deliverables, looking for âœ… or âŒ
                const prDeliverablesSection = prBody.match(/## ğŸš§ Deliverables from Issue\n([\s\S]*?)(?=\n## |$)/);
                let prDeliverables = {};
                if (prDeliverablesSection) {
                  const checklistItems = prDeliverablesSection[1].match(/- [âœ…âŒ]\s*.+/g);
                  if (checklistItems) {
                    checklistItems.forEach(item => {
                      const checked = item.startsWith('- âœ…');
                      const text = item.replace(/^- [âœ…âŒ]\s*/, '').trim();
                      prDeliverables[text] = checked;
                    });
                  }
                }

                // Build new deliverables checklist with emojis
                let newDeliverables = issueDeliverables.map(item => {
                  const checked = prDeliverables[item] ? 'âœ…' : 'âŒ';
                  return `- ${checked} ${item}`;
                }).join('\n');

                // Update PR body with new deliverables
                const newPrBody = prBody.replace(
                  /(## ğŸš§ Deliverables from Issue\n)[\s\S]*?(?=\n## |$)/,
                  `$1${newDeliverables}\n`
                );

                // Update PR only if body has changed
                if (newPrBody !== prBody) {
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    pull_number: prNumber,
                    body: newPrBody
                  });
                }
              }
            }