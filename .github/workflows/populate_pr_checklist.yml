name: PR Template and Deliverables

on:
  pull_request:
    types: [opened, edited]

jobs:
  update-pr-body:
    runs-on: ubuntu-latest
    steps:
      - name: Update PR Body
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Define the template for a blank PR body
            const template = `## ✨ Description

            <!-- Clearly describe what this PR does. What feature, fix, or update are you introducing? -->

            ---

            ## 🐛 Related Issue

            Closes #

            ---

            ## 🚧 Deliverables from Issue

            <!-- These will be auto-filled from the related issue if matched. -->

            ---

            ## ✅ Checklist

            - [ ] 💻 Code compiles and builds successfully without errors
            - [ ] 🧪 Relevant tests (unit/integration) are added or updated
            - [ ] 🏆 All tests pass locally and on CI
            - [ ] 📚 Documentation has been updated (if applicable)
            - [ ] 👀 Reviewer(s) have been assigned

            ---

            ## 💬 Additional Notes

            <!-- Optional: Any extra context, decisions made, or things to look out for -->`;

            // If PR body is blank, insert the template
            if (!prBody.trim()) {
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                body: template
              });
            } else {
              // Try to extract issue number, prioritizing the "Related Issue" section in the body
              let issueNumber = null;
              const relatedIssueSection = prBody.match(/## 🐛 Related Issue\n([\s\S]*?)(?=\n## |$)/);
              if (relatedIssueSection) {
                const closesMatch = relatedIssueSection[1].match(/closes\s+#(\d+)/i);
                if (closesMatch) {
                  issueNumber = closesMatch[1];
                }
              }

              // If no issue number in body, check the title (e.g., "Fix #53: R")
              if (!issueNumber) {
                const titleMatch = prTitle.match(/\b(fix|fixes|fixed|close|closes|closed|resolve|resolves|resolved)\s+#(\d+)/i);
                if (titleMatch) {
                  issueNumber = titleMatch[2];
                }
              }

              // If an issue number is found, fetch and update deliverables
              if (issueNumber) {
                // Fetch the issue body
                const issue = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber
                });
                const issueBody = issue.data.body || '';

                // Extract deliverables from the issue
                const deliverablesSection = issueBody.match(/## Deliverables\n([\s\S]*?)(?=\n## |$)/);
                let issueDeliverables = [];
                if (deliverablesSection) {
                  const listItems = deliverablesSection[1].match(/- .+/g);
                  if (listItems) {
                    issueDeliverables = listItems.map(item => item.replace(/^- /, '').trim());
                  }
                }

                // Extract current deliverables checklist from PR body, handling multiple checkboxes
                const prDeliverablesSection = prBody.match(/## 🚧 Deliverables from Issue\n([\s\S]*?)(?=\n## |$)/);
                let prDeliverables = {};
                if (prDeliverablesSection) {
                  const checklistItems = prDeliverablesSection[1].match(/- (\[[ x]\]\s*)+.+/g);
                  if (checklistItems) {
                    checklistItems.forEach(item => {
                      // Match all checkboxes and take the last one as the state
                      const checkboxMatches = item.match(/\[[ x]\]/g);
                      const lastCheckbox = checkboxMatches[checkboxMatches.length - 1];
                      const checked = lastCheckbox === '[x]';
                      const text = item.replace(/- (\[[ x]\]\s*)+/, '').trim();
                      prDeliverables[text] = checked;
                    });
                  }
                }

                // Build the new deliverables checklist, keeping existing checked states
                let newDeliverables = issueDeliverables.map(item => {
                  const checked = prDeliverables[item] ? 'x' : ' ';
                  return `- [${checked}] ${item}`;
                }).join('\n');

                // Update the PR body with the new deliverables section
                const newPrBody = prBody.replace(
                  /(## 🚧 Deliverables from Issue\n)[\s\S]*?(?=\n## |$)/,
                  `$1${newDeliverables}\n`
                );

                // Update the PR only if the body has changed
                if (newPrBody !== prBody) {
                  await github.rest.pulls.update({
                    owner,
                    repo,
                    pull_number: prNumber,
                    body: newPrBody
                  });
                }
              }
            }