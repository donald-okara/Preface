name: Populate PR body from linked issue

on:
  pull_request:
    types: [opened, edited, synchronize]
  workflow_dispatch:

jobs:
  populate:
    runs-on: ubuntu-latest
    steps:
      - name: Populate PR with issue deliverables if body is empty
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prBodyIsEmpty = !pr.body || pr.body.trim() === "";

            const titleMatch = pr.title.match(/Fix\s+#(\d+):/i);
            const bodyMatch = pr.body?.match(/Closes\s+#(\d+)/i);
            const issueNumber = titleMatch?.[1] || bodyMatch?.[1];

            if (!prBodyIsEmpty || !issueNumber) {
              return; // Skip if PR has content or no issue found
            }

            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const issueBody = issue.data.body || "";

            // Try to extract "## Deliverables" section
            const deliverablesMatch = issueBody.match(/## Deliverables([\s\S]*?)(##|$)/i);
            let deliverablesSection = deliverablesMatch ? deliverablesMatch[1].trim() : issueBody.trim();

            // Convert to markdown checklist
            const deliverablesLines = deliverablesSection
              .split('\n')
              .map(line => line.trim())
              .filter(line => line.length > 0)
              .map(line => `- [ ] ${line}`)
              .join('\n');

            const prBody = `
            ## Description âœ¨
            
            <!-- What does this PR do? -->
            
            ## Related Issue ğŸ›
            
            Closes #${issueNumber}
            
            ## Checklist âœ…
            
            ${deliverablesLines}
            
            ## Additional Notes ğŸ’¬
            
            <!-- Any additional context for the reviewer? -->
                        `;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: prBody
            });